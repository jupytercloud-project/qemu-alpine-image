version: 2.1

executors:
  vm:
    machine:
      enabled: true
      image: circleci/classic:latest

jobs:
  build:
    executor: vm
    shell: /bin/bash --login -eo pipefail
    environment:
      DKR: https://github.com/jupytercloud-project/build-container/releases/download/0.0.1/jupytercloud-project_build-container_latest.dkr
      IMAGE_NAME: build_container
      IMAGE: jupytercloud-project/build-container:latest
    steps:
    - checkout
    - run:
        name: "Defining environment variables"
        command: |
          echo 'export VOLUME=/home/circleci/project:/src' >> ${BASH_ENV}
    - run:
        name: "Pulling build container"
        command: curl --location ${DKR} | docker load
    - run:
        name: "Running build container"
        command: |
          docker run \
                 --name ${IMAGE_NAME} \
                 --detach \
                 --interactive \
                 --rm \
                 --volume ${VOLUME} \
                 ${IMAGE} /bin/bash
          docker exec \
                 ${IMAGE_NAME} \
                 /bin/bash -c 'ls -alFhR /src/tools/hashicorp/packer/images/qemu-alpine-image'
          docker exec \
                 ${IMAGE_NAME} \
                 src/tools/hashicorp/packer/images/qemu-alpine-image/build.bash

